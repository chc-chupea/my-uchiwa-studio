<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Myうちわ — アップロード版（長押し保存プレビュー付き）</title>
  <style>
    body { font-family: sans-serif; text-align: center; background-color: #f9f9f9; margin: 0; padding: 10px; }
    #canvasWrapper { position: relative; width: 100%; max-width: 900px; aspect-ratio: 4 / 3; margin: 0 auto; background-color: #f4f4f4; }
    #mainCanvas { width: 100%; height: auto; background-color: white; touch-action: none; }
    #templateSelector, #imageLoader, #saveBtn { margin-top: 10px; font-size: 14px; }
    .form-button { background:#45a049; color:white; padding:8px 12px; border-radius:8px; border:none; }
    button { cursor: pointer; }
    #previewImage { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h1 data-ja="Myうちわ — アップロード版">Myうちわ — アップロード版</h1>

  <p style="font-size:12px; color:#666;" data-ja="スマホの写真をアップロードして、テンプレートと合成した画像を長押しで保存できます。">スマホの写真をアップロードして、テンプレートと合成した画像を長押しで保存できます。</p>

  <div id="canvasWrapper">
    <canvas id="mainCanvas" width="3508" height="2480"></canvas>
  </div>

  <!-- プレビュー領域（保存は長押し） -->
  <div id="previewWrapper" style="display:none; text-align:center; margin-top:16px;">
    <img id="previewImage" alt="合成画像プレビュー" style="max-width:90%; border:1px solid #ccc; border-radius:10px;" />
    <div style="margin-top:10px;">
      <a id="openImageBtn" href="#" target="_blank" class="form-button" style="display:none; padding:8px 14px; font-size:14px; border-radius:8px; margin-right:8px; text-decoration:none;">🔍 大きく表示（新しいタブ）</a>
    </div>
  </div>

  <button id="saveBtn" class="form-button">💾 保存する</button>
  <p id="notice"></p>
  <div id="saveInstructions" style="font-size: 12px; color: #333; margin-top: 10px;"></div>

  <br>
  <button id="go-to-form" style="display:inline-block; margin-top:10px;">📝 注文フォームへ進む</button>

  <div id="manual-link" style="display: none; margin-top:8px;"></div>

  <input type="file" id="imageLoader" accept="image/*" style="margin-top:12px;" />
  <select id="templateSelector" style="margin-top:12px;">
    <option value="fan1-highres.png">うちわテンプレートA（高解像度）</option>
    <option value="fan2-highres.png">うちわテンプレートB（高解像度）</option>
    <option value="fan3-highres.png">うちわテンプレートB（高解像度）</option>
  </select>

<script>
    const saveWarningTexts = {
      ja: '⚠️ まだファイルが選ばれていません。うちわに使う画像を選んでください。',
      en: '⚠️ No file selected yet. Please upload an image.',
      zh: '⚠️ 尚未选择文件，请上传图片。',
      ko: '⚠️ 아직 파일이 선택되지 않았습니다. 이미지를 업로드하세요.',
      vi: '⚠️ Chưa chọn tệp. Vui lòng tải ảnh lên.',
    };

    const saveInstructionsTexts = {
      ja: `※ 保存方法：プレビュー画像を長押しして「写真に追加」または「画像を保存」を選んでください。`,
      en: `※ Save: Long-press the preview image and choose "Save Image" or similar.`,
      zh: `※ 保存方式：长按预览图片，选择“保存图片”或“添加到照片”。`,
      ko: `※ 저장 방법: 미리보기 이미지를 길게 눌러 "이미지 저장"을 선택하세요.`,
      vi: `※ Lưu: Nhấn và giữ ảnh xem trước rồi chọn "Lưu ảnh".`,
    };

    // 現在の言語コード
    let currentLang = 'ja';

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let uploadedImg = null;
    let imgX = 100, imgY = 100, imgScale = 1, rotation = 0;

    const templateSelector = document.getElementById('templateSelector');

    // 画像ファイル選択処理
    document.getElementById('imageLoader').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        uploadedImg = img;
        // 初期位置/スケール調整
        imgScale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
        imgX = (canvas.width - img.width * imgScale) / 2;
        imgY = (canvas.height - img.height * imgScale) / 2;
        draw();
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    // テンプレート読み込み（簡易）
    const templateImg = new Image();
    templateImg.src = templateSelector.value; // select の value にファイル名を入れておく
    templateSelector.addEventListener('change', () => {
      templateImg.src = templateSelector.value;
    });

    templateImg.onload = () => draw();

    // 描画
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // 背景白
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // アップロード画像を描画（位置・スケール・回転）
      if (uploadedImg) {
        ctx.save();
        // transform 用に中心を移動
        const cx = imgX + (uploadedImg.width * imgScale) / 2;
        const cy = imgY + (uploadedImg.height * imgScale) / 2;
        ctx.translate(cx, cy);
        ctx.rotate(rotation);
        ctx.translate(-cx, -cy);
        ctx.drawImage(uploadedImg, imgX, imgY, uploadedImg.width * imgScale, uploadedImg.height * imgScale);
        ctx.restore();
      }

      // テンプレートを最前面に描画
      if (templateImg.complete) {
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      }
    }

    // 簡易操作（キーボードでのテスト用）
    window.addEventListener('keydown', (e) => {
      if (e.key === '+' || e.key === '=') { imgScale *= 1.05; draw(); }
      if (e.key === '-') { imgScale /= 1.05; draw(); }
      if (e.key === 'ArrowLeft') rotation -= 0.05;
      if (e.key === 'ArrowRight') rotation += 0.05;
      draw();
    });

    // ---------- 保存ボタンの新しい処理（プレビュー表示 + 長押し保存） ----------
    document.getElementById('saveBtn').addEventListener('click', () => {
      const noticeEl = document.getElementById('notice');

      if (!uploadedImg) {
        noticeEl.textContent = saveWarningTexts[currentLang] || saveWarningTexts['ja'];
        noticeEl.style.color = 'red';
        setTimeout(() => {
          noticeEl.textContent = '';
          noticeEl.style.color = 'green';
        }, 3000);
        return;
      }

      // canvas を Blob にしてプレビュー表示（長押しで保存する方式）
      canvas.toBlob(blob => {
        if (!blob) {
          noticeEl.textContent = '画像作成に失敗しました。もう一度お試しください。';
          noticeEl.style.color = 'red';
          return;
        }

        // 前の object URL があれば解放
        if (window._lastPreviewURL) {
          try { URL.revokeObjectURL(window._lastPreviewURL); } catch (e) {}
          window._lastPreviewURL = null;
        }

        const url = URL.createObjectURL(blob);
        window._lastPreviewURL = url;

        // プレビュー要素を表示
        const previewWrapper = document.getElementById('previewWrapper');
        const previewImg = document.getElementById('previewImage');
        const openBtn = document.getElementById('openImageBtn');

        if (previewImg) previewImg.src = url;
        if (previewWrapper) previewWrapper.style.display = 'block';

        // iPhone/Android 向けの案内を出す
        noticeEl.style.display = 'block';
        noticeEl.style.color = 'black';
        noticeEl.innerHTML = `
          iPhone：画像を👆長押しして「“写真”に追加」を選んで保存してください。<br><br>
          Android：画像を👆長押しして「画像を保存」を選択してください。<br><br>
          保存できたら下の「注文フォームへ進む」ボタンから申込へお進みください。
        `;

        // 「新しいタブで表示」ボタンを blob URL に設定（任意）
        if (openBtn) {
          openBtn.href = url;
          openBtn.download = getTimestampBasedFileName();
          openBtn.style.display = 'inline-block';
        }

        // スクロールして目立たせる
        if (previewWrapper) previewWrapper.scrollIntoView({ behavior: 'smooth' });

      }, 'image/png'); // PNG で生成
    });
    // -------------------------------------------------------------------

    // 簡易タッチ操作（ピンチ／パン／回転は既存のライブラリか追加実装を推奨）
    let isDragging = false, startX = 0, startY = 0;
    canvas.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }
    });
    canvas.addEventListener('touchmove', (e) => {
      if (isDragging && e.touches.length === 1) {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        imgX += dx * (canvas.width / canvas.getBoundingClientRect().width);
        imgY += dy * (canvas.height / canvas.getBoundingClientRect().height);
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        draw();
      }
    });
    canvas.addEventListener('touchend', (e) => { isDragging = false; });

    // 言語切替（簡易）
    function setLanguage(lang) {
      // 現在の言語を設定
      currentLang = lang;
      document.querySelectorAll('[data-ja]').forEach(el => {
        if (el.dataset[lang]) {
          el.innerHTML = el.dataset[lang];
        }
      });

      // 保存説明文を切り替える
      const instructionEl = document.getElementById('saveInstructions');
      if (saveInstructionsTexts[lang]) {
        instructionEl.innerHTML = saveInstructionsTexts[lang];
      } else {
        instructionEl.innerHTML = saveInstructionsTexts['ja']; // デフォルト日本語
      }
    }

    // ファイル名生成
    function getTimestampBasedFileName() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const h = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const slot = Math.floor(parseInt(min) / 30) * 30;
      const slotStr = String(slot).padStart(2, '0');
      return `uchiwa_${y}${m}${d}_${h}${slotStr}.png`;
    }

    // 注文フォームへの遷移ボタン
    document.getElementById('go-to-form').addEventListener('click', () => {
      // 実際のフォームURLをここに置き換えてください
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform";
      window.open(formUrl, '_blank');
    });

    // 初期呼び出し
    draw();
</script>
</body>
</html>
