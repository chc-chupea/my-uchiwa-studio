<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Myã†ã¡ã‚ â€” ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆï¼ˆé•·æŠ¼ã—ä¿å­˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ãï¼‰</title>
  <style>
    body { font-family: sans-serif; text-align: center; background-color: #f9f9f9; margin: 0; padding: 10px; }
    #canvasWrapper { position: relative; width: 100%; max-width: 900px; aspect-ratio: 4 / 3; margin: 0 auto; background-color: #f4f4f4; }
    #mainCanvas { width: 100%; height: auto; background-color: white; touch-action: none; }
    #templateSelector, #imageLoader, #saveBtn { margin-top: 10px; font-size: 14px; }
    .form-button { background:#45a049; color:white; padding:8px 12px; border-radius:8px; border:none; }
    button { cursor: pointer; }
    #previewImage { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h1 data-ja="Myã†ã¡ã‚ â€” ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ">Myã†ã¡ã‚ â€” ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ</h1>

  <p style="font-size:12px; color:#666;" data-ja="ã‚¹ãƒãƒ›ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åˆæˆã—ãŸç”»åƒã‚’é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™ã€‚">ã‚¹ãƒãƒ›ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åˆæˆã—ãŸç”»åƒã‚’é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™ã€‚</p>

  <div id="canvasWrapper">
    <canvas id="mainCanvas" width="3508" height="2480"></canvas>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é ˜åŸŸï¼ˆä¿å­˜ã¯é•·æŠ¼ã—ï¼‰ -->
  <div id="previewWrapper" style="display:none; text-align:center; margin-top:16px;">
    <img id="previewImage" alt="åˆæˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width:90%; border:1px solid #ccc; border-radius:10px;" />
    <div style="margin-top:10px;">
      <a id="openImageBtn" href="#" target="_blank" class="form-button" style="display:none; padding:8px 14px; font-size:14px; border-radius:8px; margin-right:8px; text-decoration:none;">ğŸ” å¤§ããè¡¨ç¤ºï¼ˆæ–°ã—ã„ã‚¿ãƒ–ï¼‰</a>
    </div>
  </div>

  <button id="saveBtn" class="form-button">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
  <p id="notice"></p>
  <div id="saveInstructions" style="font-size: 12px; color: #333; margin-top: 10px;"></div>

  <br>
  <button id="go-to-form" style="display:inline-block; margin-top:10px;">ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</button>

  <div id="manual-link" style="display: none; margin-top:8px;"></div>

  <input type="file" id="imageLoader" accept="image/*" style="margin-top:12px;" />
  <select id="templateSelector" style="margin-top:12px;">
    <option value="fan1-highres.png">ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆAï¼ˆé«˜è§£åƒåº¦ï¼‰</option>
    <option value="fan2-highres.png">ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆBï¼ˆé«˜è§£åƒåº¦ï¼‰</option>
    <option value="fan3-highres.png">ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆBï¼ˆé«˜è§£åƒåº¦ï¼‰</option>
  </select>

<script>
    const saveWarningTexts = {
      ja: 'âš ï¸ ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã†ã¡ã‚ã«ä½¿ã†ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',
      en: 'âš ï¸ No file selected yet. Please upload an image.',
      zh: 'âš ï¸ å°šæœªé€‰æ‹©æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡ã€‚',
      ko: 'âš ï¸ ì•„ì§ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.',
      vi: 'âš ï¸ ChÆ°a chá»n tá»‡p. Vui lÃ²ng táº£i áº£nh lÃªn.',
    };

    const saveInstructionsTexts = {
      ja: `â€» ä¿å­˜æ–¹æ³•ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã«è¿½åŠ ã€ã¾ãŸã¯ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`,
      en: `â€» Save: Long-press the preview image and choose "Save Image" or similar.`,
      zh: `â€» ä¿å­˜æ–¹å¼ï¼šé•¿æŒ‰é¢„è§ˆå›¾ç‰‡ï¼Œé€‰æ‹©â€œä¿å­˜å›¾ç‰‡â€æˆ–â€œæ·»åŠ åˆ°ç…§ç‰‡â€ã€‚`,
      ko: `â€» ì €ì¥ ë°©ë²•: ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ "ì´ë¯¸ì§€ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.`,
      vi: `â€» LÆ°u: Nháº¥n vÃ  giá»¯ áº£nh xem trÆ°á»›c rá»“i chá»n "LÆ°u áº£nh".`,
    };

    // ç¾åœ¨ã®è¨€èªã‚³ãƒ¼ãƒ‰
    let currentLang = 'ja';

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let uploadedImg = null;
    let imgX = 100, imgY = 100, imgScale = 1, rotation = 0;

    const templateSelector = document.getElementById('templateSelector');

    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
    document.getElementById('imageLoader').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        uploadedImg = img;
        // åˆæœŸä½ç½®/ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
        imgScale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
        imgX = (canvas.width - img.width * imgScale) / 2;
        imgY = (canvas.height - img.height * imgScale) / 2;
        draw();
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆç°¡æ˜“ï¼‰
    const templateImg = new Image();
    templateImg.src = templateSelector.value; // select ã® value ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥ã‚Œã¦ãŠã
    templateSelector.addEventListener('change', () => {
      templateImg.src = templateSelector.value;
    });

    templateImg.onload = () => draw();

    // æç”»
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // èƒŒæ™¯ç™½
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’æç”»ï¼ˆä½ç½®ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»å›è»¢ï¼‰
      if (uploadedImg) {
        ctx.save();
        // transform ç”¨ã«ä¸­å¿ƒã‚’ç§»å‹•
        const cx = imgX + (uploadedImg.width * imgScale) / 2;
        const cy = imgY + (uploadedImg.height * imgScale) / 2;
        ctx.translate(cx, cy);
        ctx.rotate(rotation);
        ctx.translate(-cx, -cy);
        ctx.drawImage(uploadedImg, imgX, imgY, uploadedImg.width * imgScale, uploadedImg.height * imgScale);
        ctx.restore();
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æœ€å‰é¢ã«æç”»
      if (templateImg.complete) {
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      }
    }

    // ç°¡æ˜“æ“ä½œï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆç”¨ï¼‰
    window.addEventListener('keydown', (e) => {
      if (e.key === '+' || e.key === '=') { imgScale *= 1.05; draw(); }
      if (e.key === '-') { imgScale /= 1.05; draw(); }
      if (e.key === 'ArrowLeft') rotation -= 0.05;
      if (e.key === 'ArrowRight') rotation += 0.05;
      draw();
    });

    // ---------- ä¿å­˜ãƒœã‚¿ãƒ³ã®æ–°ã—ã„å‡¦ç†ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º + é•·æŠ¼ã—ä¿å­˜ï¼‰ ----------
    document.getElementById('saveBtn').addEventListener('click', () => {
      const noticeEl = document.getElementById('notice');

      if (!uploadedImg) {
        noticeEl.textContent = saveWarningTexts[currentLang] || saveWarningTexts['ja'];
        noticeEl.style.color = 'red';
        setTimeout(() => {
          noticeEl.textContent = '';
          noticeEl.style.color = 'green';
        }, 3000);
        return;
      }

      // canvas ã‚’ Blob ã«ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆé•·æŠ¼ã—ã§ä¿å­˜ã™ã‚‹æ–¹å¼ï¼‰
      canvas.toBlob(blob => {
        if (!blob) {
          noticeEl.textContent = 'ç”»åƒä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
          noticeEl.style.color = 'red';
          return;
        }

        // å‰ã® object URL ãŒã‚ã‚Œã°è§£æ”¾
        if (window._lastPreviewURL) {
          try { URL.revokeObjectURL(window._lastPreviewURL); } catch (e) {}
          window._lastPreviewURL = null;
        }

        const url = URL.createObjectURL(blob);
        window._lastPreviewURL = url;

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ã‚’è¡¨ç¤º
        const previewWrapper = document.getElementById('previewWrapper');
        const previewImg = document.getElementById('previewImage');
        const openBtn = document.getElementById('openImageBtn');

        if (previewImg) previewImg.src = url;
        if (previewWrapper) previewWrapper.style.display = 'block';

        // iPhone/Android å‘ã‘ã®æ¡ˆå†…ã‚’å‡ºã™
        noticeEl.style.display = 'block';
        noticeEl.style.color = 'black';
        noticeEl.innerHTML = `
          iPhoneï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œâ€œå†™çœŸâ€ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br><br>
          Androidï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><br>
          ä¿å­˜ã§ããŸã‚‰ä¸‹ã®ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç”³è¾¼ã¸ãŠé€²ã¿ãã ã•ã„ã€‚
        `;

        // ã€Œæ–°ã—ã„ã‚¿ãƒ–ã§è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’ blob URL ã«è¨­å®šï¼ˆä»»æ„ï¼‰
        if (openBtn) {
          openBtn.href = url;
          openBtn.download = getTimestampBasedFileName();
          openBtn.style.display = 'inline-block';
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç›®ç«‹ãŸã›ã‚‹
        if (previewWrapper) previewWrapper.scrollIntoView({ behavior: 'smooth' });

      }, 'image/png'); // PNG ã§ç”Ÿæˆ
    });
    // -------------------------------------------------------------------

    // ç°¡æ˜“ã‚¿ãƒƒãƒæ“ä½œï¼ˆãƒ”ãƒ³ãƒï¼ãƒ‘ãƒ³ï¼å›è»¢ã¯æ—¢å­˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹è¿½åŠ å®Ÿè£…ã‚’æ¨å¥¨ï¼‰
    let isDragging = false, startX = 0, startY = 0;
    canvas.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }
    });
    canvas.addEventListener('touchmove', (e) => {
      if (isDragging && e.touches.length === 1) {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        imgX += dx * (canvas.width / canvas.getBoundingClientRect().width);
        imgY += dy * (canvas.height / canvas.getBoundingClientRect().height);
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        draw();
      }
    });
    canvas.addEventListener('touchend', (e) => { isDragging = false; });

    // è¨€èªåˆ‡æ›¿ï¼ˆç°¡æ˜“ï¼‰
    function setLanguage(lang) {
      // ç¾åœ¨ã®è¨€èªã‚’è¨­å®š
      currentLang = lang;
      document.querySelectorAll('[data-ja]').forEach(el => {
        if (el.dataset[lang]) {
          el.innerHTML = el.dataset[lang];
        }
      });

      // ä¿å­˜èª¬æ˜æ–‡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
      const instructionEl = document.getElementById('saveInstructions');
      if (saveInstructionsTexts[lang]) {
        instructionEl.innerHTML = saveInstructionsTexts[lang];
      } else {
        instructionEl.innerHTML = saveInstructionsTexts['ja']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥æœ¬èª
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
    function getTimestampBasedFileName() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const h = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const slot = Math.floor(parseInt(min) / 30) * 30;
      const slotStr = String(slot).padStart(2, '0');
      return `uchiwa_${y}${m}${d}_${h}${slotStr}.png`;
    }

    // æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®é·ç§»ãƒœã‚¿ãƒ³
    document.getElementById('go-to-form').addEventListener('click', () => {
      // å®Ÿéš›ã®ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ã“ã“ã«ç½®ãæ›ãˆã¦ãã ã•ã„
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform";
      window.open(formUrl, '_blank');
    });

    // åˆæœŸå‘¼ã³å‡ºã—
    draw();
</script>
</body>
</html>
